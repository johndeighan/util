# logger.lib.civet

import {cyan, blue, black} from 'jsr:@std/fmt/colors'

import {write, writeln} from 'console-utils'
import {isString} from 'datatypes'
import {OL, ML} from 'to-nice'

let level = 0
export INDENT := Symbol 'indent'
export UNDENT := Symbol 'undent'

# --- useful for unit testing
#     or saving final log to a log file
export let lLogLines: string[] = []

# ---------------------------------------------------------------------------

logLine := (
		str: string,
		oneIndent: string = '\t'
		): void =>

	line := oneIndent.repeat(level) + str
	lLogLines.push line
	writeln line
	return

# ---------------------------------------------------------------------------

export getLog := (): string =>

	return lLogLines.join('\n')

# ---------------------------------------------------------------------------

export type TLogLevel = 'silent' | 'info' | 'debug'

let lLogLevels: TLogLevel[] = ['info']

# ---------------------------------------------------------------------------

export curLogLevel := (): TLogLevel =>

	if (lLogLevels.length == 0)
		return 'info'
	else
		return lLogLevels[lLogLevels.length - 1]

# ---------------------------------------------------------------------------

export setLogLevel := (level: TLogLevel): void =>

	if (lLogLevels.length > 0)
		lLogLevels[lLogLevels.length - 1] = level
	return

# ---------------------------------------------------------------------------

export pushLogLevel := (level: TLogLevel): void =>

	lLogLevels.push level
	return

# ---------------------------------------------------------------------------

export popLogLevel := (): TLogLevel =>

	if (lLogLevels.length == 0)
		return 'info'
	else
		retval := lLogLevels[lLogLevels.length - 1]
		lLogLevels.pop()
		return retval

# ---------------------------------------------------------------------------

export LOG := (...lItems: unknown[]): void =>

	if (curLogLevel() != 'silent')
		for item of lItems
			if (item == INDENT)
				level += 1
			else if (item == UNDENT)
				if (level > 0)
					level -= 1
			else if isString(item)
				writeln item
			else
				writeln OL(item)
	return

# ---------------------------------------------------------------------------

export DBG := (...lItems: unknown[]): void =>

	if (curLogLevel() == 'debug')
		LOG ...lItems
	return

# ---------------------------------------------------------------------------

export LOGVALUE := (label: string, value: unknown): void =>

	LOG "#{label} = #{ML(value)}"
	return

# ---------------------------------------------------------------------------

export DBGVALUE := (label: string, value: unknown): void =>

	DBG blue(label) + " = #{ML(value)}"
	return

